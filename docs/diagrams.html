<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>システム設計図 (Mermaid)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
            margin-bottom: 2rem;
        }

        .diagram-container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        h2 {
            margin-top: 0;
            color: #334155;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body>
    <h1>システム設計図</h1>

    <div class="diagram-container">
        <h2>1. 業務フロー (System Workflow)</h2>
        <div class="mermaid">
            graph TD
            %% レーン定義
            subgraph Data ["データソース/連携"]
            PreResults["前月/前週実績"]
            Master["商品/店舗マスタ"]
            end

            subgraph User_MD ["MD/BY (計画策定)"]
            M1["M1 販売実績確認"]
            M2["M2 戦略/定常 商品改廃"]

            subgraph Planning ["詳細計画策定"]
            M3["M3 基準売価設定/更新"]
            M4["M4 商品目標金額調整"]
            M5["M5 売上/粗利確認 Rep."]
            end

            Meeting["販売会議 (修正・確定)"]

            subgraph Registration ["システム登録"]
            M6["M6 戦略/定常登録"]
            M7["M7 商品目標金額確定"]
            Report["月次/週次販売計画 Rep."]
            end
            end

            subgraph User_Mgr ["BULeader/部長 (承認)"]
            Approval{"M8 計画確認・承認"}
            end

            %% フロー接続
            PreResults --> M1
            Master --> M1
            M1 --> M2

            M2 -->|変更あり| M3
            M2 -->|変更なし| M4

            M3 --> M4
            M4 --> M5
            M5 --> Meeting

            Meeting -->|要修正| M4
            Meeting -->|確定| M6

            M6 --> M7
            M7 --> Report
            Report --> Approval

            Approval -->|NG/差戻| Meeting
            Approval -->|OK/完了| End(("計画確定"))

            %% システム支援機能
            Sys_Support["自動格上提案/予測シミュレーション"] -.-> M2
            Sys_Support -.-> M4
        </div>
    </div>

    <div class="diagram-container">
        <h2>2. データモデル (ER Diagram)</h2>
        <div class="mermaid">
            erDiagram
            %% --- マスタデータ ---

            %% 商品階層
            CATEGORY ||--|{ SUB_CATEGORY : contains
            SUB_CATEGORY ||--|{ PRODUCT : contains

            %% 店舗階層
            AREA ||--|{ STORE : contains
            CHANNEL ||--|{ STORE : classifies

            %% --- トランザクションデータ ---

            %% 販売計画
            SALES_PLAN ||--|{ PLAN_DETAIL : has

            %% 計画明細は商品またはカテゴリに紐づく
            PLAN_DETAIL }|--|| PRODUCT : targets_sku
            PLAN_DETAIL }|--|| SUB_CATEGORY : targets_subcategory

            %% 実績データ
            ACTUAL_PERFORMANCE }|--|| PRODUCT : reference
            ACTUAL_PERFORMANCE }|--|| STORE : reference

            %% --- エンティティ定義 ---

            PRODUCT {
            string id PK "商品ID/SKU"
            string jan "JANコード"
            string name "商品名"
            int cost "原価"
            int price "売価"
            boolean isStrategic "戦略商品フラグ"
            string strategyType "戦略/定常区分"
            string supplier "仕入先"
            string aggVariety "みなし品種"
            }

            CATEGORY {
            string id PK "カテゴリID"
            string name "カテゴリ名 (例: 食品)"
            }

            SUB_CATEGORY {
            string id PK "サブカテゴリID"
            string name "サブカテゴリ名 (例: 生鮮食品)"
            string parent_id FK
            }

            STORE {
            string id PK "店舗ID"
            string name "店舗名"
            string fmtCode "FMTコード (L/M/S)"
            string department "管轄部門"
            float salesRatio "売上構成比"
            }

            AREA {
            string id PK "エリアID"
            string name "エリア名 (例: 関東)"
            }

            CHANNEL {
            string id PK "チャネルID"
            string name "チャネル名"
            string fmtCode "FMTコード"
            }

            SALES_PLAN {
            string id PK "計画ID"
            string name "計画名"
            string type "計画種別 (yearly/monthly/weekly)"
            string period "対象期間"
            string status "ステータス (draft/pending/approved)"
            string version "バージョン"
            string updatedBy "最終更新者"
            }

            PLAN_DETAIL {
            string planId FK
            string targetId FK "商品IDまたはカテゴリID"
            int sales "計画売上"
            int quantity "計画数量"
            int grossProfit "計画粗利"
            }

            ACTUAL_PERFORMANCE {
            date date "年月/日付"
            string productId FK
            string storeId FK
            int sales "売上実績"
            int quantity "数量実績"
            int grossProfit "粗利実績"
            int shrinkage "廃棄金額"
            int shrinkageQty "廃棄数量"
            int markdown "値下金額"
            int markdownQty "値下数量"
            }
        </div>
    </div>

    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</body>

</html>